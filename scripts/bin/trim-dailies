#!/bin/sh
set -e

NUM_KEEP=10
BASEDIR=/srv/d-i.debian.org/www/daily-images/
BINDIR=$(dirname $0)

if [ -z "$TRIM_LOG" ]; then
	TRIM_LOG=trim.log
fi
#(
	# echo TRIMMING OLD BUILDS
        if [ -n "$NUM_KEEP" ] && [ "$NUM_KEEP" != 0 ]; then
		for ARCH in `find $BASEDIR -maxdepth 1 -mindepth 1 -type d | xargs -n1 basename`
		do
                	find $BASEDIR/$ARCH -maxdepth 1 | egrep '/[0-9][0-9][0-9][0-9]+-?[0-9][0-9]-?[0-9][0-9]-?[0-9]*:?[0-9]*$' | \
                        	sort -n | $BINDIR/trim-daily-builds "$NUM_KEEP" | \
                        	xargs rm -rf
		done
        else
                echo "(keeping all old builds)"
        fi
        #)  >> $TRIM_LOG 2>&1
