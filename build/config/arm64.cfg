MEDIUM_SUPPORTED = netboot device-tree

KERNELMAJOR = 2.6
# The version of the kernel to use.
KERNELVERSION = $(LINUX_KERNEL_ABI)-arm64
KERNELNAME = vmlinuz

GRUB_EFI=y
GRUB_PLATFORM=arm64-efi
GRUB_EFI_NAME=aa64

arch_boot_screens:
arch_tree:

# Extract GRUB EFI files.
.PHONY: arm64_grub_efi
arm64_grub_efi:
ifeq ($(GRUB_EFI),y)
	efi-image $(TEMP_GRUB_EFI) arm64-efi aa64
endif

.PHONY: arch_miniiso
arch_miniiso: arm64_grub_efi
	-rm -f $(TEMP_CD_TREE)/*
	mkdir -p $(TEMP_CD_TREE)

	ln -f $(TEMP_KERNEL) $(TEMP_CD_TREE)/linux
	ln -f $(TEMP_INITRD) $(TEMP_CD_TREE)/initrd.gz

	if [ "$(GRUB_EFI)" = y ]; then \
		set -e; \
		mkdir -p $(TEMP_CD_TREE)/boot/grub/arm64-efi; \
		cp -a $(TEMP_GRUB_EFI)/efi.img $(TEMP_CD_TREE)/boot/grub/; \
		cat boot/arm64/grub/grub-efi.cfg \
		| bootvars-subst KERNEL /linux \
			INITRD /initrd.gz \
		> $(TEMP_CD_TREE)/boot/grub/grub.cfg; \
		cp -a $(TEMP_GRUB_EFI)/boot/grub/arm64-efi/* \
			$(TEMP_CD_TREE)/boot/grub/arm64-efi/; \
	fi

	if [ "$(GRUB_EFI)" = y ]; then \
		xorriso -as mkisofs -r -J -c boot.cat \
			-boot-load-size 4 -boot-info-table \
			-eltorito-alt-boot \
			--efi-boot boot/grub/efi.img -no-emul-boot \
			-o $(TEMP_MINIISO) $(TEMP_CD_TREE); \
	fi
